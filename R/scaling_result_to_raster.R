#' Convert scaling result to spatial raster
#' 
#' converts the scaling result of mdgp_scale() to spatial raster objects#'
#' @param scaling_result data frame with scaling results generated by function mdgp_scale
#' @param class_name_field field name that contains scaled class names
#' @param proj_info projection information of coordinates in the data frame to be converted to raster
#' @param scale_factor ratio of lower (scaled) resolution to higher (original) raster resolution (resolution of lower resolution divided by resolution of higher resolution) 
#' 
#' @returns List with 3 objects. Two SpatRaster objects and a list with two objects.\cr
#' The two scaled raster results are a categorical SpatRaster object with the scaled classified map and scaled class labels in the attribute table, and a numeric SpatRaster object with cell-level information retention. The second object contains a data frame with class-specific information retention and landscape-scale information retention.
#'  
#' @export
#' 
#' @examples 
#' # load categorical raster
#' r <- terra::rast(system.file("extdata/nlm_mid_geom_r3_sa0.tif", package = "landscapeScaling"))
#' 
#' # subset the raster to the lower 300 by 300 pixels
#' r_sub <- terra::crop(r,terra::ext(0,300,0,300))
#' 
#' # generate relative abundance for the scaled grid
#' rel_abund <- relative_abundance_scaled_grid(r_sub,class_field='cover',scale_factor=15)
#' 
#' head(rel_abund)
#' 
#' # classify relative abundance samples to multidimensional grid points
#' mdgp_result <- mdgp_scale(rel_abund,parts=3,rpr_threshold=10,monotypic_threshold=90)
#' 
#' head(mdgp_result)
#' 
#' # rasterize the scaling result
#' scaled_map <- scaling_result_to_raster(mdgp_result,class_name_field='class_name',scale_factor=15)
#' 
#' print(scaled_map)
#' 
#' # plot the scaled raster
#' # scaled color scheme for six lasses
#' clr_scale <- c('#E69F00','#56B4E9','#009E73','#F0E442','#0072B2','#D55E00')
#' terra::plot(scaled_map[[1]],col=clr_scale,mar=c(1.5,1.5,1,1))
#' 
#' # plot the information retention raster
#' terra::plot(scaled_map[[2]],plg=list(ext=c(310,315,20,220),loc = "right"),
#' col=gray.colors(20,start=0.1,end=1),mar=c(1.5,1.5,1,1))
#' 
#' @seealso \code{\link{relative_abundance_scaled_grid}} to generate relative abundance for each scaled grid cell,
#'     \code{\link{mdgp_scale}} classifying relative abundance samples to multi-dimensional grid points.

scaling_result_to_raster <- function(scaling_result,class_name_field,proj_info=NA,scale_factor) {
  
  # add x and y coordinates
  scaling_result$x <- as.numeric(sapply(strsplit(as.character(scaling_result$x_y),'_'), "[", 1) ) + scale_factor/2
  scaling_result$y <- as.numeric(sapply(strsplit(as.character(scaling_result$x_y),'_'), "[", 2) ) + scale_factor/2
  
  # re-factor class ID
  newClsIDs <- as.data.frame(unique(scaling_result[class_name_field]))
  newClsIDs <- as.data.frame(newClsIDs[order(newClsIDs$class_name),]);names(newClsIDs) <- class_name_field
  newClsIDs$ID <- c(1:nrow(newClsIDs))
  
  # merge new class IDs
  scaling_result <- merge(scaling_result, newClsIDs, by=class_name_field, sort=FALSE)
  
  # create raster
  r_class <- terra::rast(as.data.frame(scaling_result)[, c('x','y','ID')],type='xyz',crs=proj_info)
  #rat <- unique(scaling_result[c('id', class_name_field)])
  levels(r_class) <- newClsIDs[c('ID',class_name_field)]
  
  # convert information retention to raster
  r_information_retention <- terra::rast(as.data.frame(scaling_result)[, c('x','y','prc_inf_agr')],type='xyz',crs=proj_info)
  
  # summary of scaled raster
  scaled_raster_summary <- info_retention_stats(scaling_result=scaling_result,class_name_field=class_name_field)
  
  return(list(r_class,r_information_retention,scaled_raster_summary))
}
